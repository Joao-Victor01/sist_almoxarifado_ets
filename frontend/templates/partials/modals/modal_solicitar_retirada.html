<div class="modal fade" id="modalSolicitarRetirada" tabindex="-1" aria-labelledby="modalSolicitarRetiradaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="modalSolicitarRetiradaLabel">Solicitar Retirada de Itens</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="form-solicitar-retirada">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="solicitar_setor_id" class="form-label">Setor*</label>
                            <select class="form-select" id="solicitar_setor_id" name="setor_id" required>
                                <option value="" disabled selected>Selecione um setor</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="local-solicitation-section">
                            <label for="solicitado_localmente_por" class="form-label">Solicitado Localmente Por (Opcional)</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="solicitado_localmente_por" name="solicitado_localmente_por" placeholder="Nome do solicitante (se não for usuário logado)">
                                <button type="button" class="btn btn-outline-secondary" id="btn-open-search-user-modal" title="Vincular a um usuário existente">
                                    <i class="bi bi-person-fill-add"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted" id="solicitado-localmente-help-text">Preencha se a solicitação for feita por alguém presencialmente em seu nome.</small>
                            <div id="linked-user-display" class="mt-2" style="display: none;">
                                <p class="mb-0">Usuário Vinculado: <strong id="linked-user-name"></strong> <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="btn-unlink-user"><i class="bi bi-x-circle"></i> Desvincular</button></p>
                                <input type="hidden" id="linked_usuario_id" name="linked_usuario_id">
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="solicitar_justificativa" class="form-label">Justificativa da Retirada</label>
                            <textarea class="form-control" id="solicitar_justificativa" name="justificativa" rows="3" placeholder="Motivo da retirada (Ex: Manutenção de Equipamento)"></textarea>
                        </div>

                        <hr class="my-4">

                        <h5>Itens para Retirada</h5>
                        <div id="itens-para-retirada-container" class="row g-3 mb-3">
                            <div class="col-12 text-muted" id="no-items-message">Nenhum item adicionado ainda.</div>
                        </div>
                        
                        <div class="row g-3 align-items-end">
                            <div class="col-12" id="selected-item-display" style="display: none;">
                                <p class="mb-1">Item Selecionado: <strong id="selected-item-name"></strong></p>
                                </div>
                            <div class="col-md-6">
                                <label for="quantidade_add_item" class="form-label"> Quantidade</label>
                                <input type="number" class="form-control" id="quantidade_add_item" min="1" value="1" placeholder="Qtd. do item selecionado">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="button" class="btn btn-info w-100 me-2" id="btn-abrir-selecionar-item-modal">Selecionar Item</button>
                                <button type="button" class="btn btn-success w-100" id="btn-adicionar-item-retirada" disabled>Adicionar à Lista</button>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btn-salvar-solicitacao-retirada">Solicitar Retirada</button>
            </div>
        </div>
    </div>
</div>

<!-- Novo Modal para Buscar Usuários -->
<div class="modal fade" id="modalSearchUser" tabindex="-1" aria-labelledby="modalSearchUserLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="modalSearchUserLabel">Buscar Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="search-user-input" placeholder="Buscar por nome ou SIApe">
                    <button class="btn btn-primary" type="button" id="btn-search-user"><i class="bi bi-search"></i> Buscar</button>
                </div>
                <div id="user-search-results-container" class="table-responsive">
                    <table class="table table-bordered table-striped" id="user-search-results-table">
                        <thead class="table-secondary">
                            <tr>
                                <th>Nome</th>
                                <th>Email</th>
                                <th>SIApe</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="user-search-results-tbody">
                            <tr><td colspan="4" class="text-center">Nenhum usuário encontrado.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>
